---
title: "Clustering_country"
author: "Thibault Herpe"
date: "05/05/2020"
output: html_document
---

Loading the dataset
```{r, error=FALSE, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
library(readxl)
library(dplyr)

dataset_final2 <- read_excel("dataset_final.xlsx")

#dataset_final2 <- subset(dataset_final2, ISO != "VNM")

```


Retrieving of the Per Capita Income from the World Bank (NY.GNP.PCAP.CD, 2018, 229 Countries)
```{r, error=FALSE, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
library(WDI)
library(plyr)

#RETRIEVING of the RNB PER INHABITANT for ALL COUNTRIES
RNB_hab_year <- WDI(indicator = "NY.GNP.PCAP.CD", 
                   country = "all", 
                   start = 2018, 
                   end = NULL)

#CONTROL of NA VALUES
#any(is.na(RNB_hab_year))
#sum(is.na(RNB_hab_year))


#Handling MISSING VALUES
RNB_hab_year <- na.omit(RNB_hab_year)

#RENAMING of COLUMNS
names(RNB_hab_year)[1] <- "ISO2"
names(RNB_hab_year)[2] <- "Country"
names(RNB_hab_year)[3] <- "RNB_inhab_year"


#DELETING UNWANTED COLMUNS
RNB_hab_year$year <- NULL
RNB_hab_year[2] <- NULL

na.omit(RNB_hab_year)

```

Merging the dataset final with the per capita income by year
```{r, error=FALSE, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
library(dplyr)

#INNER_JOIN the RNB PER INHABITANT with the DATASET FINAL (different rows in ISO CODE)
dataset_Eco = inner_join(dataset_final2, RNB_hab_year, by = "ISO2")

#DELETING UNWANTED COLUMNS
dataset_Eco[3:6] <- NULL
dataset_Eco[5:7] <- NULL


```


Loading of voice accountability index, corruption index, rule of law index and govnerment effectiveness index from the World Governance Indicators data base of the World Bank (2018)
```{r, error=FALSE, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
library(readxl)
library(dplyr)

#LOADING WGI dataset VOICE ACCOUNTABILITY
dataset_WGI1 <- read_excel("Datasets/World Governance Indicator/dataset_WGI_2018_Voice_Accountability.xlsx")

names(dataset_WGI1)

#DELETING specific ROWS where values == #N/A
#JAI PAS TROUVE DE FONCTION POUR FAIRE CA SUPPRIMER UN HASHTAG NA ... VOUS EN CONNAISSEZ ?
dataset_WGI1 <- subset(dataset_WGI1, Estimate != "#N/A")

dataset_WGI1

#DELETING UNWANTED COLUMNS
dataset_WGI1 <- dataset_WGI1[1:3]

#RENAMING COLUMNS 
names(dataset_WGI1)[1] <- "Country"
names(dataset_WGI1)[2] <- "ISO"
names(dataset_WGI1)[3] <- "Voice Accountability"


#################################################################
#LOADING WGI dataset CORRUPTION
dataset_WGI2 <- read_excel("Datasets/World Governance Indicator/dataset_WGI_2018_Corruption.xlsx")


#DELETING specific ROWS where values == #N/A
dataset_WGI2 <- subset(dataset_WGI2, Estimate != "#N/A")

#DELETING UNWANTED COLUMNS
dataset_WGI2 <- dataset_WGI2[1:3]

#RENAMING COLUMNS 
names(dataset_WGI2)[1] <- "Country"
names(dataset_WGI2)[2] <- "ISO"
names(dataset_WGI2)[3] <- "Corruption"

#################################################################
#LOADING WGI dataset RULE OF LAW
dataset_WGI3 <- read_excel("Datasets/World Governance Indicator/dataset_WGI_2018_Rule_of_Law.xlsx")


#DELETING specific ROWS where values == #N/A
dataset_WGI3 <- subset(dataset_WGI3, Estimate != "#N/A")

#DELETING UNWANTED COLUMNS
dataset_WGI3 <- dataset_WGI3[1:3]

#RENAMING COLUMNS 
names(dataset_WGI3)[1] <- "Country"
names(dataset_WGI3)[2] <- "ISO"
names(dataset_WGI3)[3] <- "Rule of Law"

#################################################################
#LOADING WGI dataset GOVERNMENT EFFECTIVENESS
dataset_WGI4 <- read_excel("Datasets/World Governance Indicator/dataset_WGI_2018_Government_Effectiveness.xlsx")


#DELETING specific ROWS where values == #N/A
dataset_WGI4 <- subset(dataset_WGI4, Estimate != "#N/A")

#DELETING UNWANTED COLUMNS
dataset_WGI4 <- dataset_WGI4[1:3]

#RENAMING COLUMNS 
names(dataset_WGI4)[1] <- "Country"
names(dataset_WGI4)[2] <- "ISO"
names(dataset_WGI4)[3] <- "Government Effectiveness"

```


Merging of voice accountability index, corruption index, rule of law index and govnerment effectiveness index together
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#MERGING VOICE ACCOUNTABILITY and CORRUPTION by ISO code
dataset_WGI2$Country  <- NULL
dataset_intermediaire = merge(dataset_WGI1, dataset_WGI2, by = "ISO")


#MERGING VOICE ACCOUNTABILITY, CORRUPTION and RULE of LAW by ISO code
dataset_WGI3$Country  <- NULL
dataset_intermediaire = merge(dataset_intermediaire, dataset_WGI3, by = "ISO")

#MERGING VOICE ACCOUNTABILITY, CORRUPTION, RULE of LAW and GOVERNMENT EFFECTIVENESS by ISO code
dataset_WGI4$Country  <- NULL
dataset_final2 = merge(dataset_intermediaire, dataset_WGI4, by = "ISO")

```


Loading of a translation index for ISO country code and country name
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(readxl)
library(dplyr)

#IMPORT and SAVING of ISO COUNTRY CODE index
ISO_COUNTRY <- read_excel("3.2 ISO_COUNTRY_TRANSLATION_V2.xlsx")

```

Loading Universal Health Coverage (UHC) - Service Capacity and Acess index from the World Health Organization (2018)
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(readxl)
library(dplyr)

#IMPORT and SAVING of ISO COUNTRY CODE index
service_capacity_access <- read_excel("UHC-service_capacity_access.xlsx")

```

Combining of ISO country code translation file and Universal Health Coverage (UHC) - Service Capacity and Acess index
```{r, error=FALSE, warning=FALSE, message=FALSE, fig.align='center', echo=FALSE}
library(dplyr)

#TESTING differences existance
dataset_antijoin = anti_join(service_capacity_access, ISO_COUNTRY, by = "Country")

#JOINING SERVICE CAPACITY and ACCESS with ISO COUNTRY file
service_capacity_access_index = full_join(service_capacity_access, ISO_COUNTRY, by = "Country")

service_capacity_access_index <- na.omit(service_capacity_access_index)

names(service_capacity_access_index)[2] <- "Service Capacity and Access"

#SAVING and WRITING of the DATASET EXCEL FILE
library(writexl)

write_xlsx(x = service_capacity_access_index, path = "service_capacity_access_index.xlsx", col_names = TRUE)

```

Merging dataset final and service capacity and access index.
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#MERGING DATASET FINAL and DATASET ISO CAPACITY by ISO code
service_capacity_access_index$Country  <- NULL
dataset_final2 = merge(dataset_final2, service_capacity_access_index, by = "ISO")
dataset_final2$ISO2 <- NULL

```


Saving dataset World Governance Indicator plus Access and Capacity to the Health Care system in a excel file
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#SAVING DATASET FINAL in a EXCEL FILE
write_xlsx(x = dataset_final2, path = "Datasets/dataset_final_WGI_capacity_access.xlsx", col_names = TRUE)

```

Merging of the WGIndicator plus Access and Capacity dataset with the Press, Democracy and Per Capita Income from the World Bank
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
#MERGING DATASET ECO and DATASET FINAL 2
dataset_Eco$Country <- NULL
dataset_final2 = merge(dataset_final2, dataset_Eco, by = "ISO")

```

Saving dataset final in a excel file
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#SAVING DATASET FINAL in a EXCEL FILE
write_xlsx(x = dataset_final2, path = "Datasets/dataset_final_2.xlsx", col_names = TRUE)

```


Now that we've got our final dataset regrouping for 147 147 countries : Press Liberty index, Democracy index, Per Capita Income index, Corruption index, Rule of Law index, Government Effectiveness index, Voice and Accountability index, Service Capacity and Acces index, we can run correlation test. The p-value chosen is 0.05.
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#LOADIND and SAVING of DATASET FINAL
dataset_final_correl2 <- dataset_final2

dataset_final_correl2[,1:2] <- NULL
dataset_final_correl2[9] <- NULL


#COMPUTATION of the CENTERING MATRIX 
mcov <- scale(dataset_final_correl2)

na.omit(mcov)

#SAVING MCOV as a DATA FRAME
covariance_matrix <- as.data.frame(mcov)


#CORRELATION TEST with HANDLING of MISSING VALUES
mcor <- cor(covariance_matrix, method = "pearson", use = "complete.obs")

#SAVING MCOR as a DATA FRAME
correlation_matrix <- as.data.frame(mcor)

#COMPUTATION of the P-VALUE COEEFICIENT
library(Hmisc)
p_value <- rcorr(as.matrix(correlation_matrix))

p_value_matrix <- as.data.frame(p_value$P)

#DISPLAYING of SIGNIFICANT CORRELATION GRAPHIC
library(corrplot)

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(p_value$r, method="color", col=col(200), type="full", order="hclust", number.cex = .9, addCoef.col = "black", tl.col="black", tl.srt=45, p.mat = p_value$P, sig.level = 0.05, insig = "blank", diag=TRUE )
```

```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
#TEST SUR LES KMEANS

library(factoextra)
library(purrr)
library(cluster)

#LOADING of the DATASET FINAL2 into DATASET KMEANS1
dataset_kmeans1 <- dataset_final2

#Making the FIRST COLUMNS as ROWNAMES
dataset_kmeans <- dataset_kmeans1[,-1]
rownames(dataset_kmeans) <- dataset_kmeans1[,1]

#DELETING UNWANTED COLUMNS
dataset_kmeans[1] <- NULL
dataset_kmeans[2] <- NULL
dataset_kmeans[3] <- NULL
dataset_kmeans[4:7] <- NULL



#STANDARDIZATON of the DATASET KMEANS
scale(dataset_kmeans)


#LOOKING FOR the best number of CLUSTERS by WSS (ELBOW METHOD) and SILHOUETTE method
set.seed(40)
fviz_nbclust(dataset_kmeans, kmeans, method = "wss")

fviz_nbclust(dataset_kmeans, kmeans, method = "silhouette")

#CALCULATING the QUALITY of the CLUSTERING depending on NUMBERS of CLUSTERS
gap_stat <- clusGap(dataset_kmeans, FUN = kmeans, nstart = 25,
                    K.max = 10, B = 50)

#PRINT the RESULT
print(gap_stat, method = "firstmax")

fviz_gap_stat(gap_stat)


#APPLYING the KMEANS ALGORITHM
set.seed(2450)
clusters <- kmeans(dataset_kmeans, 3, nstart = 25)

clusters

fviz_cluster(clusters, data = dataset_kmeans)

#SAVING the COUNTRY'S CLUSTER NUMBER into DATASET FINAL2
dataset_final2$Cluster <- clusters$cluster


```

Saving dataset final in a excel file
```{r,echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

#SAVING DATASET FINAL in a EXCEL FILE
write_xlsx(x = dataset_final2, path = "Datasets/dataset_final_2.xlsx", col_names = TRUE)

```

